#!/bin/bash -ue
#
# Synchronise environment variables with the ~/.MacOSX/environment.plist.
#
# On Mac, launched gui applications do not share the process environment (and consequently the environment variables) 
# of the launching process. They do however have the environment variables configured in 
# the ~/.MacOSX/environment.plist file.
#
# Note: view the contents of your plist file with the following command:
#
#   $ defaults read ~/.MacOSX/environment
#
# The command does not accept a filename such as ~/.MacOSX/environment.plist!
#

# Exit unless Mac OS/X
[[ $(uname) != 'Darwin' ]] && exit

scriptName=$(basename $0)

domain=~/.MacOSX/environment

function export_to_plist() {
  for var in "$@"; do
#    echo "$scriptName: synchronising $var with $domain"
    cmd="defaults write $domain ${var} \"\$${var}\""
    bash -c "$cmd"
  done
}

function usage() {
  cat <<! >&2
Usage: $scriptName [-a]
       $scriptName var1 [var2 ...]

  -a        Export all environment variables.
  var       An environment variable name to export. e.g. PATH or MANPATH
!
  exit 2
}

[[ $# -eq 0 ]] && usage

if [[ $# -eq 1 && $1 == "-a" ]]; then
  # sync all environment variables.
  export_to_plist $(env | cut -d= -f1 | sort)
else
  export_to_plist "$@"
fi
