#!/bin/bash

if [[ $1 == "-?" || $1 == "-h" || $1 == "--help" || $1 == "-help" ]]; then
  echo "usage: $(basename $0) [directories to start from]" >&2
  exit 2
fi

(
  FindEm() {
    find "$@" -type d -name .git | sed -e 's-/\.git$--'
  }

  if [[ $# -eq 0 ]]; then
    repos=~/.cache/git-repos.txt
    if [[ ! -f $repos || "$(find ${repos} -mmin +1440)" != "" ]]; then
      # file is old or not foundi - regenerate.
      mkdir -p $(dirname ${repos})
      FindEm ~ >${repos}
    fi
    cat ${repos}
  else
      FindEm "$@"
  fi
) | while read repo; do
  echo -e "-- $repo --"
  (cd $repo && git gc)
  echo
done
