#!/usr/bin/env bash

set -euo pipefail

#
# Revisions in ascending date order.
#
#revision='e1456b291c53ab34f475c36092df07d6ddcb60ab' # Working version
#revision='f77e057cda60a3f96a4010a698ff3be311bf18c6' # Later but neovim is broken :(.
revision='1fe82110febdf005d97b2927610ee854a38a8f26' # Later again but no binary cache yet.
#revision='e113100be0207ec2cfd54c39a069b823aa56f58e' # EdisonCore broken

base_url=https://github.com/nixos/nixpkgs/archive
url=${base_url}/${revision}.tar.gz

set -x
NIX_PATH=nixpkgs=${url} nix-env -f '<nixpkgs>' -r -iA userPackages "$@"
set +x

exit

#
# FIXME: Fix below which provides a diff but breaks with use of `super.recurseIntoAttrs` above.
#        The `super.recurseIntoAttrs` allows you to find userPackages when doing `nix search`.

set -e
IFS=- read -r _ oldGen _ <<<"$(readlink "$(readlink ~/.nix-profile)")"
oldVersions=$(readlink ~/.nix-profile/package_versions || echo "/dev/null")
nix-env -f '<nixpkgs>' -r -iA userPackages "$@"
IFS=- read -r _ newGen _ <<<"$(readlink "$(readlink ~/.nix-profile)")"
${self.diffutils}/bin/diff --color -u --label "generation $oldGen" $oldVersions \
  --label "generation $newGen" ~/.nix-profile/package_versions \
  || true
